name: CI/CD Portfolio to Local Ubuntu

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: portfolio-jar
          path: target/portfolio-0.0.1-SNAPSHOT.jar

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download JAR
        uses: actions/download-artifact@v4
        with:
          name: portfolio-jar

      - name: Deploy to Home PC via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          # Cloudflare Host
          host: ${{ secrets.REMOTE_HOST }} 
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "portfolio-0.0.1-SNAPSHOT.jar"
          # Target our standardized web folder
          target: "/tmp" 

      - name: Move JAR and Restart Service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Move the new jar to the production folder
            sudo mv /tmp/portfolio-0.0.1-SNAPSHOT.jar /var/www/portfolio/app.jar
            # Ensure permissions for our 'portfolio' user
            sudo chown portfolio:portfolio /var/www/portfolio/app.jar
            # Restart the systemd service we created
            sudo systemctl restart portfolio.service
            # Verify it started
            sudo systemctl status portfolio.service --no-pager
